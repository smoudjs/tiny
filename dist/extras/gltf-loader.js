!function(){"use strict";var t=Tiny.Vec3,e=Tiny.Quat,r=new t,n=new t,i=new t,a=new t,o=new e,s=new e,u=new e,c=new e;function l(t,e){this.data=t,this.elapsed=0,this.weight=e||1,this.loop=!0,this.startTime=t.reduce((function(t,e){return Math.min(t,e.times[0])}),1/0),this.endTime=t.reduce((function(t,e){return Math.max(t,e.times[e.times.length-1])}),0),this.duration=this.endTime-this.startTime}l.prototype.constructor=l,Object.assign(l.prototype,{update:function(t,e){var l=this;t=t||1;var f=e?1:this.weight/t,p=this.duration?(this.loop?this.elapsed%this.duration:Math.min(this.elapsed,this.duration-.001))+this.startTime:0;this.data.forEach((function(t){var e=t.node,h=t.transform,m=t.interpolation,d=t.times,v=t.values;if(!l.duration){var y=r,g=3;return'quaternion'===h&&(y=o,g=4),y.fromArray(v,0),void(4===g?e[h].slerp(y,f):e[h].lerp(y,f))}var b=Math.max(1,d.findIndex((function(t){return t>p})))-1,x=b+1,w=(p-d[b])/(d[x]-d[b]);'STEP'===m&&(w=0);var T=r,E=n,A=i,M=a,L=3;'quaternion'===h&&(T=o,E=s,A=u,M=c,L=4),'CUBICSPLINE'===m?(T.fromArray(v,b*L*3+1*L),E.fromArray(v,b*L*3+2*L),A.fromArray(v,x*L*3+0*L),M.fromArray(v,x*L*3+1*L),T=l.cubicSplineInterpolate(w,T,E,A,M),4===L&&T.normalize()):(T.fromArray(v,b*L),M.fromArray(v,x*L),4===L?T.slerp(M,w):T.lerp(M,w)),4===L?e[h].slerp(T,f):e[h].lerp(T,f)}))},cubicSplineInterpolate:function(t,e,r,n,i){for(var a=t*t,o=a*t,s=3*a-2*o,u=o-a,c=1-s,l=u-a+t,f=0;f<e.length;f++)e[f]=c*e[f]+l*(1-t)*r[f]+s*i[f]+u*t*n[f];return e}});var f=Tiny.Mesh,p=Tiny.Mat4,h=Tiny.Texture,m=new p,d=new p,v=function(t,e,r,n){n=op.mode||gl.TRIANGLES;f.call(this,gl,{geometry:op.geometry,program:op.program,mode:n}),this.skeleton=op.skeleton,this.program=op.program,this.createBoneTexture()};function y(t){return y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},y(t)}function g(t,e,r){return g=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}()?Reflect.construct.bind():function(t,e,r){var n=[null];n.push.apply(n,e);var i=new(Function.bind.apply(t,n));return r&&b(i,r.prototype),i},g.apply(null,arguments)}function b(t,e){return b=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},b(t,e)}function x(t){return function(t){if(Array.isArray(t))return w(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return w(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return w(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function w(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function T(){T=function(){return t};var t={},e=Object.prototype,r=e.hasOwnProperty,n=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",o=i.asyncIterator||"@@asyncIterator",s=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function c(t,e,r,i){var a=e&&e.prototype instanceof p?e:p,o=Object.create(a.prototype),s=new S(i||[]);return n(o,"_invoke",{value:E(t,r,s)}),o}function l(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}t.wrap=c;var f={};function p(){}function h(){}function m(){}var d={};u(d,a,(function(){return this}));var v=Object.getPrototypeOf,g=v&&v(v(O([])));g&&g!==e&&r.call(g,a)&&(d=g);var b=m.prototype=p.prototype=Object.create(d);function x(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function w(t,e){function i(n,a,o,s){var u=l(t[n],t,a);if("throw"!==u.type){var c=u.arg,f=c.value;return f&&"object"==y(f)&&r.call(f,"__await")?e.resolve(f.__await).then((function(t){i("next",t,o,s)}),(function(t){i("throw",t,o,s)})):e.resolve(f).then((function(t){c.value=t,o(c)}),(function(t){return i("throw",t,o,s)}))}s(u.arg)}var a;n(this,"_invoke",{value:function(t,r){function n(){return new e((function(e,n){i(t,r,e,n)}))}return a=a?a.then(n,n):n()}})}function E(t,e,r){var n="suspendedStart";return function(i,a){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===i)throw a;return{value:void 0,done:!0}}for(r.method=i,r.arg=a;;){var o=r.delegate;if(o){var s=A(o,r);if(s){if(s===f)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var u=l(t,e,r);if("normal"===u.type){if(n=r.done?"completed":"suspendedYield",u.arg===f)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(n="completed",r.method="throw",r.arg=u.arg)}}}function A(t,e){var r=e.method,n=t.iterator[r];if(void 0===n)return e.delegate=null,"throw"===r&&t.iterator.return&&(e.method="return",e.arg=void 0,A(t,e),"throw"===e.method)||"return"!==r&&(e.method="throw",e.arg=new TypeError("The iterator does not provide a '"+r+"' method")),f;var i=l(n,t.iterator,e.arg);if("throw"===i.type)return e.method="throw",e.arg=i.arg,e.delegate=null,f;var a=i.arg;return a?a.done?(e[t.resultName]=a.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=void 0),e.delegate=null,f):a:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,f)}function M(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function L(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function S(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(M,this),this.reset(!0)}function O(t){if(t||""===t){var e=t[a];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var n=-1,i=function e(){for(;++n<t.length;)if(r.call(t,n))return e.value=t[n],e.done=!1,e;return e.value=void 0,e.done=!0,e};return i.next=i}}throw new TypeError(y(t)+" is not iterable")}return h.prototype=m,n(b,"constructor",{value:m,configurable:!0}),n(m,"constructor",{value:h,configurable:!0}),h.displayName=u(m,s,"GeneratorFunction"),t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===h||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,m):(t.__proto__=m,u(t,s,"GeneratorFunction")),t.prototype=Object.create(b),t},t.awrap=function(t){return{__await:t}},x(w.prototype),u(w.prototype,o,(function(){return this})),t.AsyncIterator=w,t.async=function(e,r,n,i,a){void 0===a&&(a=Promise);var o=new w(c(e,r,n,i),a);return t.isGeneratorFunction(r)?o:o.next().then((function(t){return t.done?t.value:o.next()}))},x(b),u(b,s,"Generator"),u(b,a,(function(){return this})),u(b,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},t.values=O,S.prototype={constructor:S,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(L),!t)for(var e in this)"t"===e.charAt(0)&&r.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=void 0)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function n(r,n){return o.type="throw",o.arg=t,e.next=r,n&&(e.method="next",e.arg=void 0),!!n}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],o=a.completion;if("root"===a.tryLoc)return n("end");if(a.tryLoc<=this.prev){var s=r.call(a,"catchLoc"),u=r.call(a,"finallyLoc");if(s&&u){if(this.prev<a.catchLoc)return n(a.catchLoc,!0);if(this.prev<a.finallyLoc)return n(a.finallyLoc)}else if(s){if(this.prev<a.catchLoc)return n(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return n(a.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var a=i;break}}a&&("break"===t||"continue"===t)&&a.tryLoc<=e&&e<=a.finallyLoc&&(a=null);var o=a?a.completion:{};return o.type=t,o.arg=e,a?(this.method="next",this.next=a.finallyLoc,f):this.complete(o)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),f},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),L(r),f}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var i=n.arg;L(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,r){return this.delegate={iterator:O(t),resultName:e,nextLoc:r},"next"===this.method&&(this.arg=void 0),f}},t}function E(t,e,r,n,i,a,o){try{var s=t[a](o),u=s.value}catch(t){return void r(t)}s.done?e(u):Promise.resolve(u).then(n,i)}function A(t){return function(){var e=this,r=arguments;return new Promise((function(n,i){var a=t.apply(e,r);function o(t){E(a,n,i,o,s,"next",t)}function s(t){E(a,n,i,o,s,"throw",t)}o(void 0)}))}}(v.prototype=Object.create(f.prototype)).constructor=v,Object.assign(v.prototype,{createBoneTexture:function(){if(this.skeleton.joints.length){var t=Math.max(4,Math.pow(2,Math.ceil(Math.log(Math.sqrt(4*this.skeleton.joints.length))/Math.LN2)));this.boneMatrices=new Float32Array(t*t*4),this.boneTextureSize=t,this.boneTexture=new h(this.gl,{image:this.boneMatrices,generateMipmaps:!1,type:this.gl.FLOAT,internalFormat:this.gl.renderer.isWebgl2?this.gl.RGBA32F:this.gl.RGBA,minFilter:this.gl.NEAREST,magFilter:this.gl.NEAREST,flipY:!1,width:t})}},updateUniforms:function(){var t=this;this.skeleton.joints.forEach((function(e,r){m.multiply(e.worldMatrix,e.bindInverse),t.boneMatrices.set(m,16*r)})),this.boneTexture&&(this.boneTexture.needsUpdate=!0)},draw:function(){this.program.uniforms.boneTexture||Object.assign(this.program.uniforms,{boneTexture:{value:this.boneTexture},boneTextureSize:{value:this.boneTextureSize}}),this.updateUniforms();var t=this.worldMatrix;this.worldMatrix=d,f.prototype.draw.call(this),this.worldMatrix=t}});var M,L,S,O,_,k=window.Tiny,R=k.Geometry,I=k.Object3D,j=k.Texture,C=k.Mesh,F=k.MeshLambertMaterial,P=k.Mat4,B=k.Vec3,N=k.InstancedMesh,U={5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array,'image/jpeg':Uint8Array,'image/png':Uint8Array},G={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},V={POSITION:'position',NORMAL:'normal',TANGENT:'tangent',TEXCOORD_0:'uv',TEXCOORD_1:'uv2',COLOR_0:'color',WEIGHTS_0:'skinWeight',JOINTS_0:'skinIndex'},z={translation:'position',rotation:'quaternion',scale:'scale'},D={setBasisManager:function(t){this.basisManager=t},load:(_=A(T().mark((function t(e,r){var n;return T().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=JSON.parse(r),t.next=4,this.parse(e,n,"/");case 4:return t.abrupt("return",t.sent);case 5:case"end":return t.stop()}}),t,this)}))),function(t,e){return _.apply(this,arguments)}),parse:(O=A(T().mark((function t(e,r,n){var i,a,o,s,u,c,l,f,p,h,m,d,v,y;return T().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return void 0===r.asset||r.asset.version[0],null!==(i=r.extensionsRequired)&&void 0!==i&&i.includes('KHR_texture_basisu')&&this.basisManager,t.next=4,this.loadBuffers(r,n);case 4:return a=t.sent,e.renderer.bindVertexArray(null),o=this.parseBufferViews(e,r,a),t.next=9,this.parseImages(e,r,n,o);case 9:for(s=t.sent,u=this.parseTextures(e,r,s),c=this.parseMaterials(e,r,u),l=this.parseSkins(e,r,o),f=this.parseMeshes(e,r,o,c,l),p=this.parseNodes(e,r,f,l,s),this.populateSkins(l,p),h=this.parseAnimations(e,r,p,o),m=this.parseScenes(r,p),d=m[r.scene],v=this.parseLights(e,r,p,m),y=p.length;y>=0;y--)p[y]||p.splice(y,1);return t.abrupt("return",{json:r,buffers:a,bufferViews:o,images:s,textures:u,materials:c,meshes:f,nodes:p,lights:v,animations:h,scenes:m,scene:d,getObjectByName:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:'',e=this.nodes,r=0;r<e.length;r++){var n=e[r];if(n.name===t)return n}}});case 22:case"end":return t.stop()}}),t,this)}))),function(t,e,r){return O.apply(this,arguments)}),parseDesc:(S=A(T().mark((function t(e){var r=this;return T().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.match(/\.glb/)){t.next=6;break}return t.next=3,fetch(e).then((function(t){return t.json()}));case 3:case 8:return t.abrupt("return",t.sent);case 6:return t.next=8,fetch(e).then((function(t){return t.arrayBuffer()})).then((function(t){return r.unpackGLB(t)}));case 9:case"end":return t.stop()}}),t)}))),function(t){return S.apply(this,arguments)}),unpackGLB:function(t){var e=new Uint32Array(t,0,3);if(1179937895!==e[0])throw new Error('Invalid glTF asset.');if(2!==e[1])throw new Error("Unsupported glTF binary version, \"".concat(e[1],"\"."));var r=new Uint32Array(t,12,2),n=r[0];if(1313821514!==r[1])throw new Error('Unexpected GLB layout.');var i=(new TextDecoder).decode(t.slice(20,20+n)),a=JSON.parse(i);if(20+n===t.byteLength)return a;var o=new Uint32Array(t,20+n,2);if(5130562!==o[1])throw new Error('Unexpected GLB layout.');var s=20+n+8,u=o[0],c=t.slice(s,s+u);return a.buffers[0].binary=c,a},resolveURI:function(t,e){return'string'!=typeof t||''===t?'':(/^https?:\/\//i.test(e)&&/^\//.test(t)&&(e=e.replace(/(^https?:\/\/[^\/]+).*/i,'$1')),/^(https?:)?\/\//i.test(t)||/^data:.*,.*$/i.test(t)||/^blob:.*$/i.test(t)?t:e+t)},loadBuffers:(L=A(T().mark((function t(e,r){var n=this;return T().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.buffers){t.next=2;break}return t.abrupt("return",null);case 2:return t.next=4,Promise.all(e.buffers.map((function(t){if(t.binary)return t.binary;var e=n.resolveURI(t.uri,r);return fetch(e).then((function(t){return t.arrayBuffer()}))})));case 4:return t.abrupt("return",t.sent);case 5:case"end":return t.stop()}}),t)}))),function(t,e){return L.apply(this,arguments)}),parseBufferViews:function(t,e,r){if(!e.bufferViews)return null;var n=e.bufferViews.map((function(t){return Object.assign({},t)}));return e.meshes&&e.meshes.forEach((function(r){r.primitives.forEach((function(r){var i=r.attributes,a=r.indices;for(var o in i)n[e.accessors[i[o]].bufferView].isAttribute=!0;void 0!==a&&(n[e.accessors[a].bufferView].isAttribute=!0,n[e.accessors[a].bufferView].target=t.ELEMENT_ARRAY_BUFFER)}))})),e.accessors.forEach((function(t){var e=t.bufferView,r=t.componentType;n[e].componentType=r})),e.images&&e.images.forEach((function(t){t.uri;var e=t.bufferView,r=t.mimeType;void 0!==e&&(n[e].mimeType=r)})),n.forEach((function(e,i){var a=e.buffer,o=e.byteOffset,s=void 0===o?0:o,u=e.byteLength,c=(e.byteStride,e.target),l=void 0===c?t.ARRAY_BUFFER:c,f=(e.name,e.extensions,e.extras,e.componentType,e.mimeType,e.isAttribute);if(n[i].data=r[a].slice(s,s+u),f){var p=t.createBuffer();t.bindBuffer(l,p),t.renderer.state.boundBuffer=p,t.bufferData(l,n[i].data,t.STATIC_DRAW),n[i].buffer=p}})),n},parseImages:(M=A(T().mark((function t(e,r,n,i){var a=this;return T().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r.images){t.next=2;break}return t.abrupt("return",null);case 2:return t.next=4,Promise.all(r.images.map(function(){var t=A(T().mark((function t(e){var r,o,s,u,c,l,f,p,h;return T().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=e.uri,o=e.bufferView,s=e.mimeType,u=e.name,'image/ktx2'!==s){t.next=7;break}return c=i[o].data,t.next=5,a.basisManager.parseTexture(c);case 5:return l=t.sent,t.abrupt("return",l);case 7:return(f=new Image).name=u,r?f.src=a.resolveURI(r,n):void 0!==o&&(p=i[o].data,h=new Blob([p],{type:s}),f.src=URL.createObjectURL(h)),f.ready=new Promise((function(t){f.onload=function(){return t()}})),t.abrupt("return",f);case 12:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()));case 4:return t.abrupt("return",t.sent);case 5:case"end":return t.stop()}}),t)}))),function(t,e,r,n){return M.apply(this,arguments)}),parseTextures:function(t,e,r){var n=this;return e.textures?e.textures.map((function(i){return n.createTexture(t,e,r,i)})):null},createTexture:function(t,e,r,n){var i=n.sampler,a=n.source,o=n.name,s=n.extensions;n.extras;void 0===a&&s&&s.KHR_texture_basisu&&(a=s.KHR_texture_basisu.source);var u=r[a];if(u.texture)return u.texture;var c={flipY:!1,wrapS:t.REPEAT,wrapT:t.REPEAT},l=void 0!==i?e.samplers[i]:null;if(l&&['magFilter','minFilter','wrapS','wrapT'].forEach((function(t){l[t]&&(c[t]=l[t])})),u.isBasis){c.image=u,c.internalFormat=u.internalFormat,u.isCompressedTexture&&(c.generateMipmaps=!1,u.length>1&&(this.minFilter=t.NEAREST_MIPMAP_LINEAR));var f=new j(t,c);return f.name=o,u.texture=f,f}var p=new j(t,c);return p.name=o,u.texture=p,u.ready.then((function(){p.image=u})),p},parseMaterials:function(t,e,r){return e.materials?e.materials.map((function(t){var e=t.name,n=t.extensions,i=t.extras,a=t.pbrMetallicRoughness,o=void 0===a?{}:a,s=t.normalTexture,u=t.occlusionTexture,c=t.emissiveTexture,l=t.emissiveFactor,f=void 0===l?[0,0,0]:l,p=t.alphaMode,h=void 0===p?'OPAQUE':p,m=t.alphaCutoff,d=void 0===m?.5:m,v=t.doubleSided,y=void 0!==v&&v,g=o.baseColorFactor,b=void 0===g?[1,1,1,1]:g,x=o.baseColorTexture,w=o.metallicFactor,T=void 0===w?1:w,E=o.roughnessFactor,A=void 0===E?1:E,M=o.metallicRoughnessTexture;return x&&(x.texture=r[x.index]),s&&(s.texture=r[s.index]),M&&(M.texture=r[M.index]),u&&(u.texture=r[u.index]),c&&(c.texture=r[c.index]),{name:e,extensions:n,extras:i,baseColorFactor:b,baseColorTexture:x,metallicFactor:T,roughnessFactor:A,metallicRoughnessTexture:M,normalTexture:s,occlusionTexture:u,emissiveTexture:c,emissiveFactor:f,alphaMode:h,alphaCutoff:d,doubleSided:y}})):null},parseSkins:function(t,e,r){var n=this;return e.skins?e.skins.map((function(t){var i=t.inverseBindMatrices,a=t.skeleton,o=t.joints;return{inverseBindMatrices:n.parseAccessor(i,e,r),skeleton:a,joints:o}})):null},parseMeshes:function(t,e,r,n,i){var a=this;return e.meshes?e.meshes.map((function(o,s){var u=o.primitives,c=o.weights,l=o.name,f=(o.extensions,o.extras,0),p=[],h=!1;return e.nodes&&e.nodes.forEach((function(t){var e=t.mesh,r=t.skin,n=t.extras;e===s&&(f++,void 0!==r&&p.push(r),n&&n.lightmap_scale_offset&&(h=!0))})),!!p.length?((u=p.map((function(o){return a.parsePrimitives(t,u,e,r,n,1,h).map((function(e){var r=e.geometry,n=e.program,a=e.mode,s=new v(t,{skeleton:i[o],geometry:r,program:n,mode:a});return s.name=l,s.frustumCulled=!1,s}))}))).instanceCount=0,u.numInstances=f):u=a.parsePrimitives(t,u,e,r,n,f,h).map((function(t){var e=t.geometry,r=t.program,n=t.mode,i=new(e.attributes.instanceMatrix?N:C)(e,r,{mode:n});return i.name=l,i.numInstances=f,i})),{primitives:u,weights:c,name:l}})):null},parsePrimitives:function(t,e,r,n,i,a,o){var s=this;return e.map((function(e){var u=e.attributes,c=e.indices,l=e.material,f=e.mode,p=void 0===f?4:f,h=(e.targets,e.extensions,e.extras,new F);h.initialize(t),void 0!==l&&(h.gltfMaterial=i[l]);var m=new R;for(var d in m.initialize(t),u)m.addAttribute(V[d],s.parseAccessor(u[d],r,n));return void 0!==c&&m.addAttribute('index',s.parseAccessor(c,r,n)),a>1&&m.addAttribute('instanceMatrix',{instanced:1,size:16,data:new Float32Array(16*a)}),o&&m.addAttribute('lightmapScaleOffset',{instanced:1,size:4,data:new Float32Array(4*a)}),{geometry:m,program:h,mode:p}}))},parseAccessor:function(t,e,r){var n,i=e.accessors[t],a=i.bufferView,o=i.byteOffset,s=void 0===o?0:o,u=i.componentType,c=i.normalized,l=void 0!==c&&c,f=i.count,p=i.type,h=i.min,m=i.max,d=(i.sparse,r[a]),v=d.data,y=d.buffer,g=(d.byteOffset,d.byteStride),b=void 0===g?0:g,x=(d.target,G[p]),w=U[u],T=b/w.BYTES_PER_ELEMENT;if(!!b&&T!==x){var E=new w(v,s);n=new w(f*x);for(var A=0;A<f;A++){var M=T*A,L=M+x;n.set(E.slice(M,L),A*x)}}else n=new w(v,s,f*x);return{data:n,size:x,type:u,normalized:l,buffer:y,stride:b,offset:s,count:f,min:h,max:m}},parseNodes:function(t,e,r,n,i){var a=this;if(!e.nodes)return null;var o=e.nodes.map((function(n){n.camera,n.children;var o=n.skin,s=n.matrix,u=n.mesh,c=n.rotation,l=n.scale,f=n.translation,p=(n.weights,n.name),h=n.extensions,m=n.extras,d=new I;p&&(d.name=p),d.extras=m,d.extensions=h,m&&void 0!==m.lightmapTexture&&(m.lightmapTexture.texture=a.createTexture(t,e,i,{source:m.lightmapTexture.index})),s?(d.matrix.copy(s),d.decompose()):(c&&d.quaternion.copy(c),l&&d.scale.copy(l),f&&d.position.copy(f),d.updateMatrix());var v=!1,y=!0,g=!1;if(void 0!==u&&(void 0!==o?(r[u].primitives[r[u].primitives.instanceCount].forEach((function(t){t.extras=m,t.setParent(d)})),r[u].primitives.instanceCount++,r[u].primitives.instanceCount===r[u].primitives.numInstances&&(delete r[u].primitives.numInstances,delete r[u].primitives.instanceCount)):r[u].primitives.forEach((function(t){t.extras=m,t.geometry.isInstanced&&(v=!0,t.instanceCount?y=!1:t.instanceCount=0,t.geometry.attributes.instanceMatrix&&(g=!0,d.matrix.toArray(t.geometry.attributes.instanceMatrix.data,16*t.instanceCount)),t.geometry.attributes.lightmapScaleOffset&&t.geometry.attributes.lightmapScaleOffset.data.set(m.lightmap_scale_offset,4*t.instanceCount),t.instanceCount++,t.instanceCount===t.numInstances&&(delete t.numInstances,delete t.instanceCount,t.geometry.attributes.instanceMatrix&&(t.geometry.attributes.instanceMatrix.needsUpdate=!0),t.geometry.attributes.lightmapScaleOffset&&(t.geometry.attributes.lightmapScaleOffset.needsUpdate=!0))),v?y&&t.setParent(d):t.setParent(d)}))),g){if(!y)return null;d.matrix.identity(),d.decompose()}return d}));return e.nodes.forEach((function(t,e){var r=t.children;(void 0===r?[]:r).forEach((function(t){o[t]&&o[t].setParent(o[e])}))})),r.forEach((function(t,e){t.primitives.forEach((function(t,e){t.isInstancedMesh&&t.addFrustumCull()}))})),o},populateSkins:function(t,e){t&&t.forEach((function(t){t.joints=t.joints.map((function(r,n){var i=e[r];return i.skin=t,i.bindInverse=g(P,x(t.inverseBindMatrices.data.slice(16*n,16*(n+1)))),i})),t.skeleton&&(t.skeleton=e[t.skeleton])}))},parseAnimations:function(t,e,r,n){var i=this;return e.animations?e.animations.map((function(t,a){var o=t.channels,s=t.samplers;return{name:t.name,animation:new l(o.map((function(t){var o=t.sampler,u=t.target,c=s[o],l=c.input,f=c.interpolation,p=void 0===f?'LINEAR':f,h=c.output,m=u.node,d=u.path,v=r[m],y=z[d],g=i.parseAccessor(l,e,n).data,b=i.parseAccessor(h,e,n).data;return v.animations||(v.animations=[]),v.animations.includes(a)||v.animations.push(a),{node:v,transform:y,interpolation:p,times:g,values:b}})))}})):null},parseScenes:function(t,e){return t.scenes?t.scenes.map((function(t){var r=t.nodes,n=void 0===r?[]:r,i=(t.name,t.extensions,t.extras),a=n.reduce((function(t,r){return e[r]&&t.push(e[r]),t}),[]);return a.extras=i,a})):null},parseLights:function(t,e,r,n){var i,a={directional:[],point:[],spot:[]};n.forEach((function(t){return t.forEach((function(t){return t.updateMatrixWorld()}))}));var o=(null===(i=e.extensions)||void 0===i||null===(i=i.KHR_lights_punctual)||void 0===i?void 0:i.lights)||[];return r.forEach((function(t){var e;if(null!=t&&null!==(e=t.extensions)&&void 0!==e&&e.KHR_lights_punctual){var r=t.extensions.KHR_lights_punctual.light,n=o[r],i={name:n.name||'',color:{value:(new B).set(n.color||1)}};switch(void 0!==n.intensity&&i.color.value.multiply(n.intensity),n.type){case'directional':i.direction={value:new B(0,0,1).transformDirection(t.worldMatrix)};break;case'point':i.position={value:(new B).applyMatrix4(t.worldMatrix)},i.distance={value:n.range},i.decay={value:2};break;case'spot':Object.assign(i,n)}a[n.type].push(i)}})),a}};Tiny.Cache.gltf={},Tiny.Loader.prototype.gltf=function(t,e,r,n){this.list.push({key:t,src:e,type:'gltf',split:r,cb:n})},Tiny.Loader.gltf=function(t,e){var r=t.key;function n(n){if(Tiny.Cache.gltf[r]=n,t.split){n.scene.traverse((function(t){t.isMesh&&(Tiny.Cache.mesh3d[r+'.'+t.name]=t)}));for(var i=0;i<n.animations.length;i++){var a=n.animations[i];Tiny.Cache.animation3d[r+'.'+a.name]=a}}t.cb&&t.cb(n),e()}t.src.length>200?D.parse(t.src,'',n):D.load(t.src,n)},Tiny.GLTFLoader=D}();